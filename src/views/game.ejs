<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Quiz Buzzer â€“ <%= username %>
	</title>

	<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="/game.css">
</head>

<body>

	<!-- Jeopardy Board (Desktop only) -->
	<div class="jeopardy-board desktop-only">
		<!-- Column Headers -->
		<div class="jeopardy-row jeopardy-header-row">
			<div class="jeopardy-header">Boom! Action</div>
			<div class="jeopardy-header">Laugh Attack</div>
			<div class="jeopardy-header">Creepy & Weird</div>
			<div class="jeopardy-header">Tears & Feels</div>
			<div class="jeopardy-header">Space & Sci-Fry</div>
		</div>

		<!-- Game Grid -->
		<% for(let row=1; row <=5; row++) { %>
			<div class="jeopardy-row">
				<% for(let col=1; col <=5; col++) { %>
					<div class="jeopardy-cell" data-id="r<%= row %>c<%= col %>">
						<%= row * 100 %> <!-- CHANGE THIS LINE -->
					</div>
					<% } %>
			</div>
			<% } %>

				<!-- Reset Button -->
				<div class="jeopardy-reset">
					<button onclick="resetBoard()">Reset Board</button>
				</div>

				<!-- Image Modal -->
				<div id="imageModal">
					<button onclick="closeModal()">Close</button>
					<img id="modalImage" src="" alt="Revealed Image">
				</div>
	</div>

	<!-- Game UI (mobile only) -->
	<div class="game-container mobile-only">
		<div class="header-card">
			<div class="username-display">ğŸ® <%= username %>
			</div>
			<div id="connectionStatus" class="connection-status reconnecting">
				<span>ğŸ”Œ</span>
				<span>Connecting to the fun center...</span>
			</div>
		</div>

		<div class="status-card">
			<div id="status" class="game-status">Preparing for battle...</div>
			<div id="playerList" class="player-list">Loading players...</div>
		</div>

		<div class="buzzer-card">
			<div class="buzzer-container">
				<button id="startBtn" class="start-btn">
					<span>ğŸš€ Start the Show</span>
				</button>
				<button id="tapBtn" class="buzz-button" disabled>
					<span>ğŸ”” BUZZ</span>
				</button>
			</div>
		</div>

		<div class="actions-card">
			<div class="action-buttons">
				<button class="action-btn" onclick="changeUsername()">ğŸ“ Change Name</button>
				<button class="action-btn" onclick="refreshConnection()">ğŸ”„ Refresh</button>
			</div>
		</div>

		<div class="fun-footer">
			<p>âš¡ Quick on the buzz = bragging rights for life! âš¡</p>
		</div>
	</div>

	<script>
		const JEOPARDY_KEY = 'revealedJeopardyCells';
		const revealedCells = JSON.parse(localStorage.getItem(JEOPARDY_KEY)) || {};

		const imagePaths = [
			'mission-impossible.webp', 'private-benjamin.webp', 'the-healing.webp', 'img_0_0.jpg', 'img_0_0.jpg', // Row 1
			// --------------------------------------------------------------------------------------------
			'kill-bill.jpg', 'home-alone.webp', 'evil-dead.webp', 'img_0_0.jpg', 'img_0_0.jpg',             // Row 2
			// --------------------------------------------------------------------------------------------
			'die_hard.jpg', 'shaun-of-the-dead.webp', 'midsommar.webp', 'img_0_0.jpg', 'img_0_0.jpg',       // Row 3
			// --------------------------------------------------------------------------------------------
			'tokyo_drift.jpg', 'zohan.webp', 'midnight-mass.webp', 'img_0_0.jpg', 'img_0_0.jpg',                   // Row 4
			// --------------------------------------------------------------------------------------------
			'speed.jpg', 'thousand-words.webp', 'cure-to-wellness.webp', 'img_0_0.jpg', 'img_0_0.jpg'       // Row 5
		];


		const cellImages = {};
		imagePaths.forEach((filename, index) => {
			const row = Math.floor(index / 5) + 1;
			const col = (index % 5) + 1;
			const cellId = `r${row}c${col}`;
			cellImages[cellId] = filename;
		});

		function revealImage(cell, id) {
			const img = document.createElement('img');
			img.src = cellImages[id];
			img.classList.add('jeopardy-img');
			cell.innerHTML = '';
			cell.appendChild(img);
			cell.classList.add('revealed');
			revealedCells[id] = true;
			localStorage.setItem(JEOPARDY_KEY, JSON.stringify(revealedCells));
		}

		function showModal(id) {
			const modal = document.getElementById('imageModal');
			const modalImage = document.getElementById('modalImage');
			modalImage.src = cellImages[id];
			modal.style.display = 'flex';
		}

		function closeModal() {
			const modal = document.getElementById('imageModal');
			modal.style.display = 'none';
		}

		function resetBoard() {
			localStorage.removeItem(JEOPARDY_KEY);
			localStorage.removeItem(STORAGE_KEY);

			document.querySelectorAll('.jeopardy-cell').forEach(cell => {
				const value = cell.dataset.id.match(/\d$/)[0] + "00";
				cell.innerHTML = value;
				cell.classList.remove('revealed');
			});

			alert('Board and user data have been reset. Reload the page to enter a new username.');
		}

		// Setup cells
		document.querySelectorAll('.jeopardy-cell').forEach(cell => {
			const id = cell.dataset.id;
			if (revealedCells[id]) {
				revealImage(cell, id);
			}
			cell.addEventListener('click', () => {
				if (!cell.classList.contains('revealed')) {
					revealImage(cell, id);
				}
				showModal(id);
			});
		});

		// Buzzer logic
		const STORAGE_KEY = 'quiz_buzzer_username';
		const username = "<%= username %>";
		localStorage.setItem(STORAGE_KEY, username);

		const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
		let ws = null;
		let reconnectAttempts = 0;
		const maxReconnectAttempts = 5;
		let reconnectTimeout = null;

		const status = document.getElementById('status');
		const playerList = document.getElementById('playerList');
		const tapBtn = document.getElementById('tapBtn');
		const startBtn = document.getElementById('startBtn');
		const connectionStatus = document.getElementById('connectionStatus');

		function connect() {
			if (ws && ws.readyState === WebSocket.OPEN) {
				ws.close();
			}

			ws = new WebSocket(`${protocol}//${window.location.host}/?username=${encodeURIComponent(username)}`);

			ws.onopen = () => {
				reconnectAttempts = 0;
				updateConnectionStatus('connected', 'âœ…', 'Connected & Ready!');
				status.innerText = "âœ… Ready to play!";
			};

			ws.onmessage = (event) => {
				const data = JSON.parse(event.data);
				switch (data.type) {
					case 'gameState':
						status.innerText = `ğŸ¬ Game state: ${data.state}`;
						break;
					case 'players':
						playerList.innerText = `ğŸ‘¥ Players: ${data.players.join(', ')}`;
						break;
					case 'gameStart':
						status.innerText = `ğŸš€ Countdown: ${data.countdown}`;
						startBtn.disabled = true;
						startBtn.classList.remove('pulse');
						break;
					case 'countdown':
						status.innerText = `â³ Starting in... ${data.count}`;
						status.classList.add('pulse');
						break;
					case 'gameActive':
						status.innerText = `ğŸ”” BUZZ NOW!`;
						status.classList.remove('pulse');
						tapBtn.disabled = false;
						tapBtn.classList.add('pulse');
						break;
					case 'winner':
						tapBtn.disabled = true;
						tapBtn.classList.remove('pulse');
						status.innerText = `ğŸ† ${data.winner} wins! (${data.timestamp}ms)`;
						startBtn.disabled = false;
						startBtn.classList.add('pulse');
						break;
					case 'gameReset':
						status.innerText = `ğŸ”„ Game reset. Ready for round 2!`;
						tapBtn.disabled = true;
						tapBtn.classList.remove('pulse');
						startBtn.disabled = false;
						startBtn.classList.add('pulse');
						break;
					case 'error':
						if (data.message.includes('Username taken')) {
							alert('â— Username already taken! Please choose a different name.');
							changeUsername();
						} else {
							alert(`Error: ${data.message}`);
						}
						break;
				}
			};

			ws.onclose = () => {
				updateConnectionStatus('disconnected', 'âŒ', 'Disconnected');
				status.innerText = "Connection lost...";
				tapBtn.disabled = true;
				startBtn.disabled = true;

				if (reconnectAttempts < maxReconnectAttempts) {
					reconnectAttempts++;
					updateConnectionStatus('reconnecting', 'ğŸ”„', `Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`);
					reconnectTimeout = setTimeout(() => {
						connect();
					}, 2000 * reconnectAttempts);
				} else {
					updateConnectionStatus('disconnected', 'âŒ', 'Connection failed. Please refresh!');
				}
			};

			ws.onerror = (error) => {
				console.error('WebSocket error:', error);
				updateConnectionStatus('disconnected', 'âŒ', 'Connection error');
			};
		}

		function updateConnectionStatus(type, icon, message) {
			connectionStatus.className = `connection-status ${type}`;
			connectionStatus.innerHTML = `<span>${icon}</span><span>${message}</span>`;
		}

		function refreshConnection() {
			reconnectAttempts = 0;
			if (reconnectTimeout) {
				clearTimeout(reconnectTimeout);
			}
			updateConnectionStatus('reconnecting', 'ğŸ”„', 'Reconnecting...');
			connect();
		}

		function changeUsername() {
			localStorage.removeItem(STORAGE_KEY);
			window.location.href = '/';
		}

		tapBtn.addEventListener('click', () => {
			if (ws && ws.readyState === WebSocket.OPEN) {
				const timestamp = performance.now().toFixed(1);
				ws.send(JSON.stringify({type: 'tap', username, timestamp}));
				tapBtn.disabled = true;
				tapBtn.classList.remove('pulse');
			}
		});

		startBtn.addEventListener('click', () => {
			if (ws && ws.readyState === WebSocket.OPEN) {
				ws.send(JSON.stringify({type: 'startGame'}));
				startBtn.disabled = true;
				startBtn.classList.remove('pulse');
			}
		});

		document.addEventListener('visibilitychange', () => {
			if (!document.hidden && ws && ws.readyState !== WebSocket.OPEN) {
				refreshConnection();
			}
		});

		window.addEventListener('beforeunload', () => {
			if (ws) ws.close();
		});

		connect();
		startBtn.classList.add('pulse');
	</script>
</body>

</html>
